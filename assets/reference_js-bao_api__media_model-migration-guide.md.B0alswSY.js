import{_ as s,c as i,o as a,aj as t}from"./chunks/framework.HLg5PcC2.js";const k=JSON.parse('{"title":"Migrating Decorator-Based Models to the Schema Helpers","description":"","frontmatter":{},"headers":[],"relativePath":"reference/js-bao/api/_media/model-migration-guide.md","filePath":"reference/js-bao/api/_media/model-migration-guide.md"}'),n={name:"reference/js-bao/api/_media/model-migration-guide.md"};function l(r,e,o,d,h,p){return a(),i("div",null,[...e[0]||(e[0]=[t(`<h1 id="migrating-decorator-based-models-to-the-schema-helpers" tabindex="-1">Migrating Decorator-Based Models to the Schema Helpers <a class="header-anchor" href="#migrating-decorator-based-models-to-the-schema-helpers" aria-label="Permalink to “Migrating Decorator-Based Models to the Schema Helpers”">​</a></h1><p>Created: November 14, 2025<br> Audience: Teams moving from <code>@Model</code>/<code>@Field</code> decorators to the <code>defineModelSchema</code> + <code>createModelClass</code> workflow that now powers every demo scenario.</p><hr><h2 id="_1-why-migrate" tabindex="-1">1. Why migrate? <a class="header-anchor" href="#_1-why-migrate" aria-label="Permalink to “1. Why migrate?”">​</a></h2><ul><li><strong>Single source of truth:</strong> Schema fields live in one object instead of being duplicated across decorators, TypeScript declarations, and runtime metadata.</li><li><strong>Automatic typing:</strong> <code>InferAttrs&lt;typeof schema&gt;</code> derives constructor attrs, instance fields, relationships, and defaults with no manual <code>declare</code> noise.</li><li><strong>Proxy-free runtime:</strong> BaseModel now exposes native property accessors per schema field (Phase 2); schema helpers are the easiest way to ensure every model is wired correctly.</li><li><strong>Easier codegen/tooling:</strong> Having a predictable schema object lets codegen, docs, and linters read model definitions without executing decorators.</li></ul><hr><h2 id="_2-before-you-start" tabindex="-1">2. Before you start <a class="header-anchor" href="#_2-before-you-start" aria-label="Permalink to “2. Before you start”">​</a></h2><ol><li><strong>Update to the latest <code>js-bao</code> build</strong> so <code>defineModelSchema</code>, <code>createModelClass</code>, and the accessor wiring are available. (Run <code>npm run build</code> at the repo root once.)</li><li><strong>Ensure tests cover the model.</strong> Scenarios 1–23 already do this for demos; replicate the pattern for your app.</li><li><strong>Keep runtime parity.</strong> Do not remove relationships, defaults, listeners, or custom statics yet—lift them over exactly as-is so behavior stays identical.</li></ol><hr><h2 id="_3-step-by-step-port" tabindex="-1">3. Step-by-step port <a class="header-anchor" href="#_3-step-by-step-port" aria-label="Permalink to “3. Step-by-step port”">​</a></h2><h3 id="step-1-move-field-metadata-into-definemodelschema" tabindex="-1">Step 1: Move field metadata into <code>defineModelSchema</code> <a class="header-anchor" href="#step-1-move-field-metadata-into-definemodelschema" aria-label="Permalink to “Step 1: Move field metadata into defineModelSchema”">​</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> statementSchema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineModelSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;statements&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fields: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id: { type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, autoAssign: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, indexed: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    accountName: { type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, indexed: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, default: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  options: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    uniqueConstraints: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      { name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;statements_unique_account&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fields: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;accountNumber&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;startDate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    relationships: {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // same shape you previously passed to ModelRegistry/relationships.ts</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li>Keep every bit of metadata (<code>type</code>, <code>default</code>, <code>indexed</code>, <code>required</code>, <code>relationships</code>, <code>uniqueConstraints</code>) that existed in decorators.</li><li>Use helper factories (e.g. <code>generateULID</code>) directly inside <code>default</code>.</li></ul><h3 id="step-2-infer-attrs-instance-typing" tabindex="-1">Step 2: Infer attrs &amp; instance typing <a class="header-anchor" href="#step-2-infer-attrs-instance-typing" aria-label="Permalink to “Step 2: Infer attrs &amp; instance typing”">​</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StatementAttrs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InferAttrs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> statementSchema&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Statement</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StatementAttrs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BaseModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span></code></pre></div><ul><li>This replaces <code>interface Statement extends BaseModel</code> + manual field declarations. The interface merge keeps public instance shape identical.</li></ul><h3 id="step-3-replace-the-decorated-class-with-createmodelclass" tabindex="-1">Step 3: Replace the decorated class with <code>createModelClass</code> <a class="header-anchor" href="#step-3-replace-the-decorated-class-with-createmodelclass" aria-label="Permalink to “Step 3: Replace the decorated class with createModelClass”">​</a></h3><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Statement</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createModelClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  schema: statementSchema,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  methods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    get</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> netCashFlow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.inflows </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.outflows;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  statics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">StatementClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findByAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">accountNumber</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StatementClass.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">queryOne</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ accountNumber });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><ul><li><strong>Methods:</strong> Move any prototype methods/getters into the <code>methods</code> factory.</li><li><strong>Statics:</strong> Move custom statics into the <code>statics</code> factory; the helper passes a fully typed constructor so you can call <code>query</code>, <code>find</code>, etc.</li><li><strong>Registration:</strong> No manual <code>ModelRegistry.registerModel</code> call is required; the helper registers and installs field accessors automatically.</li></ul><h3 id="step-4-update-imports-where-needed" tabindex="-1">Step 4: Update imports where needed <a class="header-anchor" href="#step-4-update-imports-where-needed" aria-label="Permalink to “Step 4: Update imports where needed”">​</a></h3><ul><li>Replace decorator imports (<code>{ Model, Field }</code>) with <code>{ defineModelSchema, createModelClass, InferAttrs }</code>.</li><li>If compiled TypeScript complains about <code>new ModelConstructor</code>, use the provided <code>TypedModelConstructor</code> helper (see <code>demos/test-app/src/types/typed-model-constructor.ts</code>) to keep <code>new Model()</code> typed as your merged interface.</li></ul><h3 id="step-5-clean-up-legacy-decorator-artifacts" tabindex="-1">Step 5: Clean up legacy decorator artifacts <a class="header-anchor" href="#step-5-clean-up-legacy-decorator-artifacts" aria-label="Permalink to “Step 5: Clean up legacy decorator artifacts”">​</a></h3><ul><li>Delete <code>@Model</code> / <code>@Field</code> usage, decorator metadata, and any static schema caches you no longer need.</li><li>Remove manual <code>declare</code> property lines—they are redundant once <code>InferAttrs</code> merges into the interface.</li></ul><hr><h2 id="_4-verifying-the-migration" tabindex="-1">4. Verifying the migration <a class="header-anchor" href="#_4-verifying-the-migration" aria-label="Permalink to “4. Verifying the migration”">​</a></h2><ol><li><strong>Build the library:</strong> <code>npm run build</code> (root) to ensure the new schema compiles.</li><li><strong>Run affected scenarios/tests:</strong> For demo models, <code>(cd demos/test-app &amp;&amp; npm run build)</code> exercises Scenarios 1–23.</li><li><strong>Console smoke-test:</strong> Instantiate the new class (<code>new Model({ … })</code>), call <code>save</code>, <code>find</code>, <code>query</code>, relationship helpers, and confirm the properties hold real values (no proxies needed).</li><li><strong>Check ModelRegistry:</strong> Ensure <code>ModelRegistry.getActiveModels()</code> still lists your model name and that relationships work by running the relevant scenario.</li></ol><hr><h2 id="_5-dynamic-runtime-models-scenarios-16" tabindex="-1">5. Dynamic/Runtime models (Scenarios 16+) <a class="header-anchor" href="#_5-dynamic-runtime-models-scenarios-16" aria-label="Permalink to “5. Dynamic/Runtime models (Scenarios 16+)”">​</a></h2><ul><li>When you register a model class manually (without <code>createModelClass</code>), make sure its <code>getSchema()</code> returns the same structure shown above. The registry now installs field accessors automatically, so <code>find()</code> results expose true properties even for dynamic models.</li></ul><hr><h2 id="_6-troubleshooting" tabindex="-1">6. Troubleshooting <a class="header-anchor" href="#_6-troubleshooting" aria-label="Permalink to “6. Troubleshooting”">​</a></h2><table tabindex="0"><thead><tr><th>Symptom</th><th>Likely cause</th><th>Fix</th></tr></thead><tbody><tr><td><code>TypeError: Cannot read properties of undefined (reading &#39;getSchema&#39;)</code></td><td>The class doesn’t expose a <code>static getSchema()</code> returning a runtime shape.</td><td>Export the schema and set <code>static schema = schema; static getSchema() { return schema.buildRuntimeShape(Class); }</code> (or just use <code>createModelClass</code>).</td></tr><tr><td><code>Property &#39;foo&#39; does not exist on type &#39;BaseModel&#39;</code></td><td>Constructor typing still references the generic <code>BaseModel</code>.</td><td>Re-export the class as <code>TypedModelConstructor&lt;Attrs&gt;</code> or the helper in <code>demos/test-app/src/types/typed-model-constructor.ts</code>.</td></tr><tr><td>Data saves but <code>find()</code> returns <code>undefined</code> fields</td><td>Accessors weren’t installed (likely because the class wasn’t registered through the helper).</td><td>Either use <code>createModelClass</code> or call <code>BaseModel.attachFieldAccessors(YourClass, schema.fields)</code> after building the schema.</td></tr><tr><td>Relationships missing</td><td>Remember to copy <code>options.relationships</code> from the decorator metadata into the schema definition, then re-run codegen if you rely on generated relationship types.</td><td></td></tr></tbody></table><hr><h2 id="_7-rolling-migration-strategy" tabindex="-1">7. Rolling migration strategy <a class="header-anchor" href="#_7-rolling-migration-strategy" aria-label="Permalink to “7. Rolling migration strategy”">​</a></h2><ol><li>Convert one model at a time, starting with leaf models that have no incoming relationships.</li><li>After each conversion, re-run relevant tests and ship behind a flag if necessary.</li><li>Once all models use schemas, delete decorator utilities and document the new authoring style for your team.</li></ol><p>Feel free to share back additional gotchas as you migrate so we can keep this guide up to date. Happy porting!</p>`,36)])])}const g=s(n,[["render",l]]);export{k as __pageData,g as default};
